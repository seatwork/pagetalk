.pgtk-container *{box-sizing:border-box}.pgtk-container{font-size:14px;line-height:1.6}.pgtk-container a{text-decoration:none}.pgtk-container a:hover{text-decoration:underline}.pgtk-container svg{fill:#999;cursor:pointer}.pgtk-section{display:flex;margin:20px 0}.pgtk-avatar{position:relative;display:flex;align-items:center;width:40px;height:40px;border-radius:50%;background:#f9f9f9}.pgtk-avatar img{width:100%;height:auto;border-radius:50%}.pgtk-triangle{position:absolute;right:-16px;width:0;height:0;border-top:8px solid transparent;border-bottom:8px solid transparent;border-right:8px solid #ccc}.pgtk-triangle:before{content:'';position:absolute;top:-7px;left:1px;width:0;height:0;border-top:7px solid transparent;border-bottom:7px solid transparent;border-right:7px solid #f9f9f9}.pgtk-comment,.pgtk-form{flex:1;margin-left:15px;overflow:hidden}.pgtk-form-inputs{display:flex}.pgtk-form-inputs>input,.pgtk-textarea{outline:0;width:100%;border-radius:5px;border:#ddd 1px solid;background:#f9f9f9;font:inherit;transition:all .3s}.pgtk-form-inputs>input:focus,.pgtk-textarea:focus{background:#fff}.pgtk-form-inputs>input{padding:7px;margin-left:10px}.pgtk-form-inputs>input:first-child{margin:0}.pgtk-textarea{margin:10px 0;padding:10px;min-height:80px;max-height:300px;overflow:auto}.pgtk-textarea:empty::before,::placeholder{content:attr(placeholder);color:#999}.pgtk-controls{display:flex}.pgtk-controls>div{flex:1}.pgtk-controls button{outline:0;padding:5px 20px;white-space:nowrap;cursor:pointer;border:1px solid #3fb960;border-radius:3px;background:#3fb960;color:#fff;font:inherit;font-size:.95em;transition:opacity .3s}.pgtk-controls button:hover{opacity:.9}.pgtk-controls button:disabled,.pgtk-controls button:disabled:hover{opacity:.6;cursor:default}.pgtk-controls button.pgtk-submit{margin-right:10px}.pgtk-controls button.pgtk-preview{background:#fff;color:#3fb960}.pgtk-profile{display:flex;align-items:center;justify-content:space-between;padding:9px 15px;color:#999;background:#f9f9f9;border:#e3e3e3 1px solid;border-bottom:0;border-top-left-radius:5px;border-top-right-radius:5px}.pgtk-profile a{color:#3fb960;font-weight:700}.pgtk-markdown{padding:15px;border:#e3e3e3 1px solid;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.pgtk-markdown img{max-width:100%}.pgtk-markdown code{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:.95em;margin:0 5px;padding:2px 5px;background:#f6f8fa}.pgtk-markdown pre{overflow:auto;background:#f6f8fa;padding:10px}.pgtk-markdown pre code{margin:0;padding:0}.pgtk-markdown blockquote,.pgtk-markdown ol,.pgtk-markdown p,.pgtk-markdown ul{margin:10px 0}.pgtk-markdown ol,.pgtk-markdown ul{margin-left:-20px}.pgtk-markdown blockquote{padding-left:10px;border-left:#ddd 3px solid;color:#999}.pgtk-markdown blockquote>:first-child,.pgtk-markdown>:first-child{margin-top:0}.pgtk-markdown blockquote>:last-child,.pgtk-markdown>:last-child{margin-bottom:0}.pgtk-markdown pre::-webkit-scrollbar{height:5px}.pgtk-markdown pre::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.1)}.pgtk-message{text-align:center;color:#999}.pgtk-error{color:#eb3941}@media (max-width:480px){.pgtk-avatar{width:30px;height:30px;margin:5px 0}.pgtk-form-inputs{flex-direction:column}.pgtk-form-inputs>input{margin:0;margin-top:10px}.pgtk-controls>div{display:none}.pgtk-controls button{flex:1}}
class PageTalk{constructor(e){this.importScripts(["https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js","https://cdn.jsdelivr.net/npm/marked@0.6.3/marked.min.js"]).then(()=>{marked.setOptions({sanitize:!0}),this.className=e.className||"PageTalk_Comment",this.lcs=new LeanCloudStorage(e),this.listComments()}),this.emailReg=/^[a-zA-Z0-9_\-\.]+\@[a-zA-Z0-9_\-\.]+\.([a-zA-Z]{2,8})$/,this.urlReg=/^https?:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z0-9\-\.]+(\:\d+)?[\w\-\/\.@?=%&+#]*$/,this.avatar="https://cn.gravatar.com/avatar/",this.onMessage=e.onMessage||function(){},this.createHeader(e.container)}createHeader(e){const t=this.loadLastUser(),s=this._(`<div class="pgtk-container"><div class="pgtk-section"><div class="pgtk-avatar"><img src="${t.avatar}"/></div><div class="pgtk-form"><div class="pgtk-form-inputs"><input type="text" id="pgtk-nickname" value="${t.nickname}" maxlength="20" placeholder="昵称 (必填)"><input type="text" id="pgtk-email" value="${t.email}" maxlength="50" placeholder="邮箱 (可选, 用于显示全球头像)"><input type="text" id="pgtk-website" value="${t.website}" maxlength="50" placeholder="网站 (可选)"></div><div class="pgtk-textarea pgtk-markdown" placeholder="不说点什么就说不过去..." contenteditable="plaintext-only"></div><div class="pgtk-controls"><div><a target="_blank" href="https://guides.github.com/features/mastering-markdown/"><svg viewBox="0 0 16 16" version="1.1" width="20" height="20"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z"></path></svg></a></div><button class="pgtk-submit">评论</button><button class="pgtk-preview">预览</button></div></div></div><div class="pgtk-message"></div><div id="pgtk-comment-list"></div></div>`);s.querySelector(".pgtk-submit").addEventListener("click",e=>this.addComment(e)),s.querySelector(".pgtk-preview").addEventListener("click",e=>this.switchPreview(e)),document.querySelector(e).appendChild(s),this.element={nickname:s.querySelector("#pgtk-nickname"),email:s.querySelector("#pgtk-email"),website:s.querySelector("#pgtk-website"),textarea:s.querySelector(".pgtk-textarea"),message:s.querySelector(".pgtk-message"),submit:s.querySelector(".pgtk-submit"),preview:s.querySelector(".pgtk-preview"),comments:s.querySelector("#pgtk-comment-list")}}async listComments(){this.setMessage("正在加载...");const e=await this.lcs.queryObjects(`select * from ${this.className} where pageId = '${location.pathname}' order by createdAt desc`);if(e.error)return this.setMessage(e.error,!0);this.setMessage(`共 ${e.results.length} 条评论`),e.results.forEach(e=>{const t=this.formatComment(e),s=this.createSection(t,e);this.element.comments.appendChild(s)})}async addComment(e){const t=this.element.textarea,s={nickname:this.element.nickname.value.trim(),email:this.element.email.value.trim(),website:this.element.website.value.trim(),content:(t.orginalContent||t.textContent).trim(),pageId:location.pathname};let a=this.verifyFormData(s);if(!0!==a)return this.setMessage(a,!0);if(this.element.submit.disabled=!0,a=await this.lcs.insertObject(this.className,s),this.element.submit.disabled=!1,a.error)return this.setMessage(a.error,!0);s.objectId=a.objectId,s.createdAt=a.createdAt;const i=this.formatComment(s),n=this.createSection(i,s),r=this.element.comments.children;0===r.length?this.element.comments.appendChild(n):this.element.comments.insertBefore(n,r[0]),this.setMessage(`共 ${r.length} 条评论`),this.clearPreview(),this.saveLastUser(i),this.onMessage(i)}createSection(e,t){const s=this._(`<div class="pgtk-section"><div class="pgtk-avatar"><img src="${e.avatar}"/><div class="pgtk-triangle"></div></div><div class="pgtk-comment"><div class="pgtk-profile"><div><a target="_blank" href="${e.website}">${e.nickname}</a> 发表于 ${e.createdAt}</div><svg id="pgtk-reply-icon" viewBox="0 0 1332 1024" width="14"><path d="M529.066665 273.066666 529.066665 0 51.2 477.866666 529.066665 955.733335 529.066665 675.84C870.4 675.84 1109.333335 785.066665 1280 1024 1211.733335 682.666665 1006.933335 341.333334 529.066665 273.066666"></path></svg></div><div class="pgtk-markdown">${e.content}</div></div></div>`);return s.querySelector("#pgtk-reply-icon").addEventListener("click",e=>this.reply(t)),s}reply(e){const t=e.content.split("\n");t.forEach((e,s)=>t[s]="> "+e),t.unshift("> @"+e.nickname),t.push("\n\n"),this.element.textarea.textContent=t.join("\n"),this.moveCursorToEnd(this.element.textarea)}switchPreview(){const e=this.element.textarea;e.isContentEditable?(e.setAttribute("contenteditable",!1),e.orginalContent=e.textContent,e.innerHTML=marked(e.textContent),this.element.preview.innerHTML="编辑"):(e.setAttribute("contenteditable","plaintext-only"),e.textContent=e.orginalContent,e.orginalContent="",this.element.preview.innerHTML="预览",this.moveCursorToEnd(e))}clearPreview(){const e=this.element.textarea;e.textContent=e.orginalContent="",e.isContentEditable||(e.setAttribute("contenteditable","plaintext-only"),this.element.preview.innerHTML="预览")}formatComment(e){const t=Object.assign({},e);return t.avatar=this.avatar+md5(e.email),t.createdAt=this.formatDate(e.createdAt),t.content=marked(e.content),t}verifyFormData(e){return e.nickname?e.nickname.match(/[\<\>]+/)?"昵称不能包含尖括号":e.email&&!e.email.match(this.emailReg)?"邮箱格式有误":e.website&&!e.website.match(this.urlReg)?"网站格式有误":e.content?!(e.content.length>2e3)||"评论内容超过 2000 字限制":"评论内容不能为空":"昵称不能为空"}setMessage(e,t=!1){this.element.message.innerHTML=e,t?this.element.message.classList.add("pgtk-error"):this.element.message.classList.remove("pgtk-error")}saveLastUser(e){localStorage.setItem("pagetalk-user",JSON.stringify({nickname:e.nickname,email:e.email,website:e.website,avatar:this.avatar+md5(e.email)}))}loadLastUser(){const e=JSON.parse(localStorage.getItem("pagetalk-user"))||{};return e.nickname=e.nickname||"",e.email=e.email||"",e.website=e.website||"",e.avatar=e.avatar||this.avatar,e}formatDate(e){return e=new Date(e).getTime()+288e5,new Date(e).toJSON().substr(0,10).replace(/\-/g,"/")}moveCursorToEnd(e){if(e.focus(),e.scrollTop=e.scrollHeight-e.clientHeight,window.getSelection){const t=window.getSelection();t.selectAllChildren(e),t.collapseToEnd()}else if(document.selection){const t=document.selection.createRange();t.moveToElementText(e),t.collapse(!1),t.select()}}importScripts(e){return new Promise((t,s)=>{const a=document.getElementsByTagName("head")[0],i=s=>{const n=document.createElement("script");n.setAttribute("type","text/javaScript"),n.setAttribute("src",e[s]),n.onload=n.onerror=()=>{++s===e.length?t():i(s)},a.appendChild(n)};i(0)})}_(e){if((e=e.replace("/\n/mg","").trim()).startsWith("<")){return document.createRange().createContextualFragment(e).firstChild}return document.querySelector(e)}}class LeanCloudStorage{constructor(e){this.api="https://avoscloud.com/1.1",this.defaultHeaders={"X-LC-Id":e.appId,"X-LC-Key":e.appKey,"Content-Type":"application/json"}}async queryObjects(e){return await this.tryFetch("/cloudQuery?cql="+e)}async getObjects(e){return await this.tryFetch("/classes/"+e)}async insertObject(e,t){return await this.tryFetch("/classes/"+e,{method:"POST",body:JSON.stringify(t)})}async deleteObject(e,t){return await this.tryFetch(`/classes/${e}/${t}`,{method:"DELETE"})}async tryFetch(e,t={}){t.headers=this.defaultHeaders;try{const s=await fetch(this.api+e,t);return await s.json()}catch(e){return{error:e.message}}}}
